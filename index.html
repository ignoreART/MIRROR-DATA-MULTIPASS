<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MIRROR Multipass Card</title>
  <link rel="preconnect" href="https://api.spacescan.io"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
    :root {
      --frame-bg: linear-gradient(145deg, #dcdcdc, #a8a8a8, #8d8d8d, #c2c2c2);
      --frame-border: #676a6c;
      --accent-color: #ff9500;
      --glass-tint: rgba(34,139,34,0.15);
    }
    body {
      margin: 0; padding: 0; height: 100vh;
      display: flex; justify-content: center; align-items: center;
      background: #101010; font-family: 'Orbitron', sans-serif; color: #e0e0e0;
    }
    #card {
      width: 480px; height: 650px; background: var(--frame-bg);
      border: 2px solid var(--frame-border); border-radius: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.8); position: relative;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .accent { width: 30px; height: 30px; background: var(--accent-color); border-radius: 6px; position: absolute; }
    .accent.tl { top: 10px; left: 10px; } .accent.br { bottom: 10px; right: 10px; }
    #header { height: 90px; border-bottom: 1px solid rgba(0,0,0,0.3); display: flex; align-items: center; padding: 10px 20px; }
    #header h1 { font-size: 1.6rem; margin: 0; color: #222; margin-right: auto; }
    #header img.mirror-logo { width: 60px; height: 60px; margin-right: 16px; }
    #aeBadge {
      width: 50px; height: 50px; border-radius: 50%;
      background: linear-gradient(135deg,#e1e4e6,#c7c9cb,#f9f9fa);
      color:#333; display:flex; align-items:center; justify-content:center;
      font-size:1.5rem; font-weight:bold; border:2px solid #a2a4a8;
      box-shadow: 0 0 0 4px rgba(193,137,69,0.6), inset 0 2px 3px rgba(255,255,255,0.8), inset 0 -2px 3px rgba(0,0,0,0.3);
    }
    #viewport {
      flex: 1; margin: 20px; border: 3px solid #444; border-radius: 12px;
      background: var(--glass-tint); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      position: relative; display: flex; flex-direction: column; justify-content: space-between; padding: 16px;
    }
    #stats { display: flex; flex-direction: column; gap: 16px; }
    #stats div { font-size: 1rem; color: #e7fff7; text-shadow: 0 0 4px rgba(0,255,255,0.8); display: flex; justify-content: space-between; }
    #stats div span:nth-child(1) { color: rgba(200,255,215,0.8); }
    #footer { height: 70px; background: linear-gradient(90deg,#4f5152,#656667,#4f5152); display:flex; flex-direction:column; justify-content:center; align-items:center; border-top:1px solid rgba(0,0,0,0.3); }
    #footer h2 { margin: 0; font-size: 1.2rem; color: #c0c8d0; }
    #footer p { margin: 2px 0 0; font-size: 0.7rem; color: #9aa2ac; text-transform: uppercase; letter-spacing: 2px; }
  </style>
</head>
<body>
  <div id="card">
    <div class="accent tl"></div>
    <div class="accent br"></div>

    <div id="header">
      <h1>MIRROR</h1>
      <img src="https://icons.dexie.space/0957ed359f099d5846c2c74c42e7c2eb9608b58c32e320e144840e3efab0b747.webp" class="mirror-logo" alt="Mirror logo"/>
      <div id="aeBadge">Ã†</div>
    </div>

    <div id="viewport">
      <div id="stats">
        <div><span>Launch (UTC)</span><span id="launchDate">--</span></div>
        <div><span>Days Deployed</span><span id="days">--</span></div>
        <div><span>Holders</span><span id="holders">--</span></div>
        <div><span>Total Supply</span><span id="total">--</span></div>
        <div><span>Circulating</span><span id="circ">--</span></div>
        <div><span>Burned</span><span id="burned">--</span></div>
        <div><span>Price (XCH)</span><span id="price">--</span></div>
        <div><span>Today</span><span id="currentDate">--</span></div>
      </div>
      <div id="worldClocks" style="margin-top:12px;font-size:0.7rem;color:#b8f5e8;display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>

    <div id="footer">
      <h2>Multipass</h2>
      <p></p>
    </div>
  </div>

  <script>
    // --- constants
    const TOKEN_ID = '0957ed359f099d5846c2c74c42e7c2eb9608b58c32e320e144840e3efab0b747';
    const LAUNCH_DATE = '2025-03-12T11:19:31Z';

    // --- launch + days
    const launchDateObj = new Date(LAUNCH_DATE);
    document.getElementById('launchDate').textContent =
      launchDateObj.toLocaleString(undefined, {year:'numeric',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'UTC'}) + ' UTC';
    document.getElementById('days').textContent =
      Math.floor((Date.now() - launchDateObj.getTime()) / 86400000).toString();

    // --- today + clocks
    function updateCurrentDate(){
      const now = new Date();
      document.getElementById('currentDate').textContent =
        now.toLocaleDateString(undefined,{year:'numeric',month:'numeric',day:'numeric'});
    }
    updateCurrentDate();

    const timeZones = [
      { label: 'UTC', zone: 'UTC' }, { label: 'New York', zone: 'America/New_York' },
      { label: 'Chicago', zone: 'America/Chicago' }, { label: 'Los Angeles', zone: 'America/Los_Angeles' },
      { label: 'London', zone: 'Europe/London' }, { label: 'Paris', zone: 'Europe/Paris' },
      { label: 'Dubai', zone: 'Asia/Dubai' }, { label: 'Mumbai', zone: 'Asia/Kolkata' },
      { label: 'Beijing', zone: 'Asia/Shanghai' }, { label: 'Tokyo', zone: 'Asia/Tokyo' },
      { label: 'Sydney', zone: 'Australia/Sydney' }
    ];
    const worldClocksContainer = document.getElementById('worldClocks');
    const clockElements = {};
    timeZones.forEach(tz => {
      const box = document.createElement('div');
      box.style.cssText = 'display:flex;flex-direction:column;align-items:center;padding:2px 4px;background:rgba(0,0,0,0.25);border-radius:4px;min-width:80px;text-align:center';
      box.innerHTML = `<strong style="font-size:0.65rem;color:#8af8e5;">${tz.label}</strong><span id="clock-${tz.label.replace(/\s+/g,'')}">--</span>`;
      worldClocksContainer.appendChild(box);
      clockElements[tz.label] = box.querySelector('span');
    });
    function updateWorldClocks(){
      const now = new Date();
      timeZones.forEach(tz => {
        clockElements[tz.label].textContent =
          now.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:tz.zone});
      });
    }
    updateWorldClocks();
    setInterval(()=>{ updateCurrentDate(); updateWorldClocks(); }, 1000);

    // --- tiny fetch helpers
    async function jfetch(url, { signal } = {}) {
      const r = await fetch(url, { signal, headers: { accept: 'application/json' } });
      if (!r.ok) throw new Error(`${r.status} ${url}`);
      return r.json();
    }
    async function retry(fn, { tries = 5, base = 300 } = {}) {
      let last;
      for (let i = 0; i < tries; i++) {
        try { return await fn(); } catch (e) {
          last = e;
          await new Promise(res => setTimeout(res, base * (2 ** i) + Math.random() * 100));
        }
      }
      throw last;
    }

    // --- holders pagination: de-dupe addresses, honor varied shapes
    async function holdersCount(signal) {
      const seen = new Set();
      let page = 1;
      const pageSize = 500; // larger pages = fewer round trips
      const hardStop = 200; // safety

      for (; page <= hardStop; page++) {
        const url = `https://api.spacescan.io/token/holders/${TOKEN_ID}?page=${page}&page_size=${pageSize}`;
        const data = await retry(() => jfetch(url, { signal }), { tries: 5, base: 300 });

        // Fast path: aggregate field present
        const aggregate = data?.holders_count ?? data?.total_holders ?? data?.total ?? null;
        if (typeof aggregate === 'number' && aggregate > 0 && page === 1) return aggregate;

        // Generic array
        const arr =
          Array.isArray(data?.tokens) ? data.tokens :
          Array.isArray(data?.holders) ? data.holders :
          Array.isArray(data?.data)    ? data.data    : [];

        for (const row of arr) {
          const addr = row?.address ?? row?.holder ?? row?.wallet_address ?? row?.puzzle_hash;
          const amount = Number(row?.amount ?? row?.balance ?? 0);
          if (addr && Number.isFinite(amount) && amount > 0) seen.add(addr);
        }

        if (!arr.length || arr.length < pageSize || data?.next === false || data?.pagination?.has_next === false) break;
      }
      return seen.size;
    }

    // --- other stats
    async function fetchStats(signal) {
      const [circ, total, priceXch, xchUsd] = await Promise.all([
        retry(() => jfetch(`https://api.spacescan.io/token/circulating-supply/${TOKEN_ID}`, { signal })),
        retry(() => jfetch(`https://api.spacescan.io/token/total-supply/${TOKEN_ID}`, { signal })),
        retry(() => jfetch(`https://api.spacescan.io/token/price/${TOKEN_ID}?currency=XCH`, { signal })),
        retry(() => jfetch(`https://api.spacescan.io/stats/price?currency=usd`, { signal })),
      ]);
      const circVal = Number(circ?.circulating_supply ?? 0);
      const totalVal = Number(total?.total_supply ?? 0);
      const burned  = (Number.isFinite(totalVal) && Number.isFinite(circVal)) ? totalVal - circVal : 0;
      const pxXch   = Number(priceXch?.price?.xch ?? 0);
      const pxUsd   = pxXch * Number(xchUsd?.price ?? 0);
      return { circ: circVal, total: totalVal, burned, priceXch: pxXch, priceUsd: pxUsd };
    }

    // --- single updater
    async function fetchTokenData(){
      const ac = new AbortController();
      const to = setTimeout(() => ac.abort(), 10000);
      try{
        const [holders, stats] = await Promise.all([
          holdersCount(ac.signal),
          fetchStats(ac.signal),
        ]);

        const n = x => Number.isFinite(x) ? x.toLocaleString() : '--';
        document.getElementById('holders').textContent = n(holders);
        document.getElementById('total').textContent   = n(stats.total);
        document.getElementById('circ').textContent    = n(stats.circ);
        document.getElementById('burned').textContent  = n(stats.burned);
        document.getElementById('price').textContent   =
          Number.isFinite(stats.priceXch) && stats.priceXch > 0
            ? `${stats.priceXch.toFixed(8)} XCH ($${stats.priceUsd.toFixed(4)})`
            : '--';
      } catch(e){
        console.error(e);
      } finally {
        clearTimeout(to);
      }
    }

    // initial + interval
    fetchTokenData();
    setInterval(fetchTokenData, 120000); // 2 min
  </script>
</body>
</html>
